{% extends 'base.html' %}

{% block title %}{{ analysis.page_title|default:"SEO Анализ" }} - Внутренний девелопмент{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>
                    <i class="bi bi-search"></i> SEO Анализ
                </h1>
                <p class="text-muted mb-0">
                    <i class="bi bi-globe"></i> 
                    <a href="{{ analysis.page_url }}" target="_blank" class="text-decoration-none">
                        {{ analysis.page_url }}
                    </a>
                </p>
                <p class="text-muted small">
                    <i class="bi bi-building"></i> 
                    {% if analysis.website.is_competitor %}
                        <span class="badge bg-warning me-1">Конкурент</span>
                    {% endif %}
                    {{ analysis.website.name|default:analysis.website.url }}
                </p>
            </div>
            <div>
                <a href="{% url 'tools:analysis_list' %}" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-arrow-left"></i> Назад к списку
                </a>
                {% if analysis.robots_txt %}
                    <a href="{% url 'tools:download_robots' analysis.pk %}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-file-text"></i> robots.txt
                    </a>
                {% endif %}
                {% if analysis.sitemap_xml %}
                    <a href="{% url 'tools:download_sitemap' analysis.pk %}" class="btn btn-outline-info">
                        <i class="bi bi-diagram-3"></i> sitemap.xml
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- SEO проблемы -->
{% if analysis.has_seo_issues %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card stats-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle text-danger"></i> 
                        Найдено {{ analysis.seo_issues|length }} SEO проблем
                    </h5>
                </div>
                <div class="card-body">
                    {% for issue in analysis.seo_issues %}
                        <div class="alert alert-{% if issue.severity == 'critical' %}danger{% elif issue.severity == 'high' %}warning{% elif issue.severity == 'medium' %}info{% else %}secondary{% endif %} mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="alert-heading mb-1">
                                        <span class="badge bg-{% if issue.severity == 'critical' %}danger{% elif issue.severity == 'high' %}warning{% elif issue.severity == 'medium' %}info{% else %}secondary{% endif %} me-2">
                                            {{ issue.get_severity_display }}
                                        </span>
                                        {{ issue.title }}
                                    </h6>
                                    <p class="mb-1">{{ issue.description }}</p>
                                    <small class="text-muted">
                                        <strong>Рекомендация:</strong> {{ issue.recommendation }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endif %}

<div class="row">
    <!-- Основная информация -->
    <div class="col-md-8">
        <!-- Мета-теги -->
        <div class="card stats-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-tags"></i> Мета-теги
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Title</h6>
                        <p class="text-muted">{{ analysis.page_title|default:"Не указан" }}</p>
                        
                        <h6>Meta Description</h6>
                        <p class="text-muted">{{ analysis.meta_description|default:"Не указан" }}</p>
                        
                        <h6>Meta Keywords</h6>
                        <p class="text-muted">{{ analysis.meta_keywords|default:"Не указаны" }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Meta Robots</h6>
                        <p class="text-muted">{{ analysis.meta_robots|default:"Не указан" }}</p>
                        
                        <h6>Canonical URL</h6>
                        <p class="text-muted">
                            {% if analysis.canonical_url %}
                                <a href="{{ analysis.canonical_url }}" target="_blank" class="text-decoration-none">
                                    {{ analysis.canonical_url }}
                                </a>
                            {% else %}
                                Не указан
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Заголовки -->
        <div class="card stats-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> Заголовки ({{ analysis.total_headings }})
                </h5>
            </div>
            <div class="card-body">
                {% if analysis.h1_tags %}
                    <h6>H1 ({{ analysis.h1_tags|length }})</h6>
                    <ul class="list-unstyled mb-3">
                        {% for tag in analysis.h1_tags %}
                            <li class="mb-1">
                                <span class="badge bg-secondary me-2">H1</span>
                                {{ tag }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if analysis.h2_tags %}
                    <h6>H2 ({{ analysis.h2_tags|length }})</h6>
                    <ul class="list-unstyled mb-3">
                        {% for tag in analysis.h2_tags %}
                            <li class="mb-1">
                                <span class="badge bg-secondary me-2">H2</span>
                                {{ tag }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if analysis.h3_tags %}
                    <h6>H3 ({{ analysis.h3_tags|length }})</h6>
                    <ul class="list-unstyled mb-3">
                        {% for tag in analysis.h3_tags %}
                            <li class="mb-1">
                                <span class="badge bg-secondary me-2">H3</span>
                                {{ tag }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if analysis.h4_tags %}
                    <h6>H4 ({{ analysis.h4_tags|length }})</h6>
                    <ul class="list-unstyled mb-3">
                        {% for tag in analysis.h4_tags %}
                            <li class="mb-1">
                                <span class="badge bg-secondary me-2">H4</span>
                                {{ tag }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if analysis.h5_tags %}
                    <h6>H5 ({{ analysis.h5_tags|length }})</h6>
                    <ul class="list-unstyled mb-3">
                        {% for tag in analysis.h5_tags %}
                            <li class="mb-1">
                                <span class="badge bg-secondary me-2">H5</span>
                                {{ tag }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if analysis.h6_tags %}
                    <h6>H6 ({{ analysis.h6_tags|length }})</h6>
                    <ul class="list-unstyled mb-3">
                        {% for tag in analysis.h6_tags %}
                            <li class="mb-1">
                                <span class="badge bg-secondary me-2">H6</span>
                                {{ tag }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>

        <!-- Open Graph -->
        {% if analysis.og_title or analysis.og_description or analysis.og_image %}
            <div class="card stats-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-share"></i> Open Graph
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>OG Title</h6>
                            <p class="text-muted">{{ analysis.og_title|default:"Не указан" }}</p>
                            
                            <h6>OG Description</h6>
                            <p class="text-muted">{{ analysis.og_description|default:"Не указан" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>OG Type</h6>
                            <p class="text-muted">{{ analysis.og_type|default:"Не указан" }}</p>
                            
                            <h6>OG Image</h6>
                            {% if analysis.og_image %}
                                <p class="text-muted">
                                    <a href="{{ analysis.og_image }}" target="_blank" class="text-decoration-none">
                                        {{ analysis.og_image }}
                                    </a>
                                </p>
                            {% else %}
                                <p class="text-muted">Не указан</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Twitter Cards -->
        {% if analysis.twitter_title or analysis.twitter_description or analysis.twitter_image %}
            <div class="card stats-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-twitter"></i> Twitter Cards
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Twitter Title</h6>
                            <p class="text-muted">{{ analysis.twitter_title|default:"Не указан" }}</p>
                            
                            <h6>Twitter Description</h6>
                            <p class="text-muted">{{ analysis.twitter_description|default:"Не указан" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Twitter Card</h6>
                            <p class="text-muted">{{ analysis.twitter_card|default:"Не указан" }}</p>
                            
                            <h6>Twitter Image</h6>
                            {% if analysis.twitter_image %}
                                <p class="text-muted">
                                    <a href="{{ analysis.twitter_image }}" target="_blank" class="text-decoration-none">
                                        {{ analysis.twitter_image }}
                                    </a>
                                </p>
                            {% else %}
                                <p class="text-muted">Не указан</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Боковая панель -->
    <div class="col-md-4">
        <!-- Техническая информация -->
        <div class="card stats-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear"></i> Техническая информация
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h6>Время ответа</h6>
                        <p class="text-muted">{{ analysis.response_time|default:"-" }} сек</p>
                    </div>
                    <div class="col-6 mb-3">
                        <h6>Размер страницы</h6>
                        <p class="text-muted">{{ analysis.page_size|default:"-" }} байт</p>
                    </div>
                    <div class="col-6">
                        <h6>HTTP статус</h6>
                        <p class="text-muted">{{ analysis.status_code|default:"-" }}</p>
                    </div>
                    <div class="col-6">
                        <h6>Заголовков</h6>
                        <p class="text-muted">{{ analysis.total_headings }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статистика -->
        <div class="card stats-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart"></i> Статистика
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h6>H1</h6>
                        <p class="text-muted">{{ analysis.h1_tags|length }}</p>
                    </div>
                    <div class="col-6 mb-3">
                        <h6>H2</h6>
                        <p class="text-muted">{{ analysis.h2_tags|length }}</p>
                    </div>
                    <div class="col-6 mb-3">
                        <h6>H3</h6>
                        <p class="text-muted">{{ analysis.h3_tags|length }}</p>
                    </div>
                    <div class="col-6 mb-3">
                        <h6>H4</h6>
                        <p class="text-muted">{{ analysis.h4_tags|length }}</p>
                    </div>
                    <div class="col-6">
                        <h6>H5</h6>
                        <p class="text-muted">{{ analysis.h5_tags|length }}</p>
                    </div>
                    <div class="col-6">
                        <h6>H6</h6>
                        <p class="text-muted">{{ analysis.h6_tags|length }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Информация об анализе -->
        <div class="card stats-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Информация
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    <strong>Сайт:</strong> 
                    <a href="{% url 'tools:website_detail' analysis.website.pk %}" class="text-decoration-none">
                        {{ analysis.website.name|default:analysis.website.url }}
                    </a>
                </p>
                <p class="mb-2">
                    <strong>Тип:</strong> 
                    {% if analysis.website.is_competitor %}
                        <span class="badge bg-warning">Конкурент</span>
                    {% else %}
                        <span class="badge bg-primary">Клиент</span>
                    {% endif %}
                </p>
                <p class="mb-2">
                    <strong>Анализ проведен:</strong> {{ analysis.created_at|date:"d.m.Y H:i" }}
                </p>
                <p class="mb-0">
                    <strong>Обновлен:</strong> {{ analysis.updated_at|date:"d.m.Y H:i" }}
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
