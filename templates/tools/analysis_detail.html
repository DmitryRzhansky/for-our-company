{% extends 'base.html' %}

{% block title %}{{ analysis.page_title|default:"SEO Анализ" }} - Внутренний девелопмент{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>
                    <i class="bi bi-search"></i> SEO Анализ
                </h1>
                <p class="text-muted mb-0">
                    <i class="bi bi-globe"></i> 
                    <a href="{{ analysis.page_url }}" target="_blank" class="text-decoration-none">
                        {{ analysis.page_url }}
                    </a>
                </p>
                <p class="text-muted small">
                    <i class="bi bi-building"></i> 
                    {% if analysis.website.is_competitor %}
                        <span class="badge bg-warning me-1">Конкурент</span>
                    {% endif %}
                    {{ analysis.website.name|default:analysis.website.url }}
                </p>
            </div>
            <div>
                <a href="{% url 'tools:analysis_list' %}" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-arrow-left"></i> Назад к списку
                </a>
                {% if analysis.robots_txt %}
                    <a href="{% url 'tools:download_robots' analysis.pk %}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-file-text"></i> robots.txt
                    </a>
                {% endif %}
                {% if analysis.sitemap_xml %}
                    <a href="{% url 'tools:download_sitemap' analysis.pk %}" class="btn btn-outline-info">
                        <i class="bi bi-diagram-3"></i> sitemap.xml
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<div class="row">
    <!-- Основная информация -->
    <div class="col-md-8">
        <!-- Мета-теги -->
        <div class="card stats-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-tags"></i> Мета-теги
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Title</h6>
                        <p class="text-muted">{{ analysis.page_title|default:"Не указан" }}</p>
                        
                        <h6>Meta Description</h6>
                        <p class="text-muted">{{ analysis.meta_description|default:"Не указан" }}</p>
                        
                        <h6>Meta Keywords</h6>
                        <p class="text-muted">{{ analysis.meta_keywords|default:"Не указаны" }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Meta Robots</h6>
                        <p class="text-muted">{{ analysis.meta_robots|default:"Не указан" }}</p>
                        
                        <h6>Canonical URL</h6>
                        <p class="text-muted">
                            {% if analysis.canonical_url %}
                                <a href="{{ analysis.canonical_url }}" target="_blank" class="text-decoration-none">
                                    {{ analysis.canonical_url }}
                                </a>
                            {% else %}
                                Не указан
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Заголовки -->
        <div class="card stats-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> Заголовки ({{ analysis.total_headings }})
                </h5>
            </div>
            <div class="card-body">
                {% if analysis.h1_tags %}
                    <h6>H1 ({{ analysis.h1_tags|length }})</h6>
                    <ul class="list-unstyled mb-3">
                        {% for tag in analysis.h1_tags %}
                            <li class="mb-1">
                                <span class="badge bg-secondary me-2">H1</span>
                                {{ tag }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if analysis.h2_tags %}
                    <h6>H2 ({{ analysis.h2_tags|length }})</h6>
                    <ul class="list-unstyled mb-3">
                        {% for tag in analysis.h2_tags %}
                            <li class="mb-1">
                                <span class="badge bg-secondary me-2">H2</span>
                                {{ tag }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if analysis.h3_tags %}
                    <h6>H3 ({{ analysis.h3_tags|length }})</h6>
                    <ul class="list-unstyled mb-3">
                        {% for tag in analysis.h3_tags %}
                            <li class="mb-1">
                                <span class="badge bg-secondary me-2">H3</span>
                                {{ tag }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if analysis.h4_tags %}
                    <h6>H4 ({{ analysis.h4_tags|length }})</h6>
                    <ul class="list-unstyled mb-3">
                        {% for tag in analysis.h4_tags %}
                            <li class="mb-1">
                                <span class="badge bg-secondary me-2">H4</span>
                                {{ tag }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if analysis.h5_tags %}
                    <h6>H5 ({{ analysis.h5_tags|length }})</h6>
                    <ul class="list-unstyled mb-3">
                        {% for tag in analysis.h5_tags %}
                            <li class="mb-1">
                                <span class="badge bg-secondary me-2">H5</span>
                                {{ tag }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if analysis.h6_tags %}
                    <h6>H6 ({{ analysis.h6_tags|length }})</h6>
                    <ul class="list-unstyled mb-3">
                        {% for tag in analysis.h6_tags %}
                            <li class="mb-1">
                                <span class="badge bg-secondary me-2">H6</span>
                                {{ tag }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>

        <!-- Простые метрики -->
        <div class="card stats-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart"></i> Простые метрики
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body">
                                <i class="bi bi-file-text display-4 mb-2"></i>
                                <h4>{{ analysis.word_count }}</h4>
                                <p class="mb-0">Слов на странице</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body">
                                <i class="bi bi-tag display-4 mb-2"></i>
                                <h4>{{ analysis.title_length }}</h4>
                                <p class="mb-0">Символов в title</p>
                                {% if analysis.title_length < 50 %}
                                    <small class="text-warning">Слишком короткий</small>
                                {% elif analysis.title_length > 60 %}
                                    <small class="text-warning">Слишком длинный</small>
                                {% else %}
                                    <small class="text-success">Оптимальный</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body">
                                <i class="bi bi-chat-text display-4 mb-2"></i>
                                <h4>{{ analysis.description_length }}</h4>
                                <p class="mb-0">Символов в description</p>
                                {% if analysis.description_length < 150 %}
                                    <small class="text-warning">Слишком короткий</small>
                                {% elif analysis.description_length > 160 %}
                                    <small class="text-warning">Слишком длинный</small>
                                {% else %}
                                    <small class="text-success">Оптимальный</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body">
                                <i class="bi bi-link-45deg display-4 mb-2"></i>
                                <h4>{{ analysis.total_links }}</h4>
                                <p class="mb-0">Всего ссылок</p>
                                <small class="text-muted">{{ analysis.internal_links }} внутр. / {{ analysis.external_links }} внеш.</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Анализ ключевых слов -->
                {% if analysis.keyword_analysis %}
                    <div class="row">
                        <div class="col-12">
                            <h6><i class="bi bi-search"></i> Анализ ключевых слов</h6>
                            {% for keyword, data in analysis.keyword_analysis.items %}
                                {% if keyword != 'headings' %}
                                    <div class="row mb-2">
                                        <div class="col-md-4">
                                            <strong>{{ keyword }}</strong>
                                        </div>
                                        <div class="col-md-4">
                                            <span class="badge bg-primary">{{ data.count }} раз</span>
                                        </div>
                                        <div class="col-md-4">
                                            <span class="badge bg-info">{{ data.density }}% плотность</span>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Ссылки -->
                <div class="row mt-3">
                    <div class="col-12">
                        <h6><i class="bi bi-link-45deg"></i> Ссылки на странице</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-house display-4 mb-2"></i>
                                        <h5>{{ analysis.internal_links }}</h5>
                                        <p class="mb-0">Внутренние ссылки</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-globe display-4 mb-2"></i>
                                        <h5>{{ analysis.external_links }}</h5>
                                        <p class="mb-0">Внешние ссылки</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-link-45deg display-4 mb-2"></i>
                                        <h5>{{ analysis.total_links }}</h5>
                                        <p class="mb-0">Всего ссылок</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Детальные ссылки -->
                        {% if analysis.detailed_links %}
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6><i class="bi bi-house"></i> Внутренние ссылки ({{ analysis.detailed_links.internal|length }})</h6>
                                    <div style="max-height: 200px; overflow-y: auto;">
                                        {% for link in analysis.detailed_links.internal %}
                                            <div class="mb-2 p-2 samurai-card" style="background-color: #000; border: 1px solid #333; border-radius: 0;">
                                                <a href="{{ link.url }}" target="_blank" class="text-decoration-none text-white">
                                                    <strong>{{ link.text|default:"Без текста" }}</strong>
                                                </a>
                                                <br>
                                                <small class="text-muted">{{ link.url }}</small>
                                                {% if link.title %}
                                                    <br>
                                                    <small class="text-info">{{ link.title }}</small>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="bi bi-globe"></i> Внешние ссылки ({{ analysis.detailed_links.external|length }})</h6>
                                    <div style="max-height: 200px; overflow-y: auto;">
                                        {% for link in analysis.detailed_links.external %}
                                            <div class="mb-2 p-2 samurai-card" style="background-color: #000; border: 1px solid #333; border-radius: 0;">
                                                <a href="{{ link.url }}" target="_blank" class="text-decoration-none text-white">
                                                    <strong>{{ link.text|default:"Без текста" }}</strong>
                                                </a>
                                                <br>
                                                <small class="text-muted">{{ link.url }}</small>
                                                {% if link.title %}
                                                    <br>
                                                    <small class="text-info">{{ link.title }}</small>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Open Graph -->
        {% if analysis.og_title or analysis.og_description or analysis.og_image %}
            <div class="card stats-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-share"></i> Open Graph
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>OG Title</h6>
                            <p class="text-muted">{{ analysis.og_title|default:"Не указан" }}</p>
                            
                            <h6>OG Description</h6>
                            <p class="text-muted">{{ analysis.og_description|default:"Не указан" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>OG Type</h6>
                            <p class="text-muted">{{ analysis.og_type|default:"Не указан" }}</p>
                            
                            <h6>OG Image</h6>
                            {% if analysis.og_image %}
                                <p class="text-muted">
                                    <a href="{{ analysis.og_image }}" target="_blank" class="text-decoration-none">
                                        {{ analysis.og_image }}
                                    </a>
                                </p>
                            {% else %}
                                <p class="text-muted">Не указан</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Twitter Cards -->
        {% if analysis.twitter_title or analysis.twitter_description or analysis.twitter_image %}
            <div class="card stats-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-twitter"></i> Twitter Cards
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Twitter Title</h6>
                            <p class="text-muted">{{ analysis.twitter_title|default:"Не указан" }}</p>
                            
                            <h6>Twitter Description</h6>
                            <p class="text-muted">{{ analysis.twitter_description|default:"Не указан" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Twitter Card</h6>
                            <p class="text-muted">{{ analysis.twitter_card|default:"Не указан" }}</p>
                            
                            <h6>Twitter Image</h6>
                            {% if analysis.twitter_image %}
                                <p class="text-muted">
                                    <a href="{{ analysis.twitter_image }}" target="_blank" class="text-decoration-none">
                                        {{ analysis.twitter_image }}
                                    </a>
                                </p>
                            {% else %}
                                <p class="text-muted">Не указан</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Боковая панель -->
    <div class="col-md-4">
        <!-- Техническая информация -->
        <div class="card stats-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear"></i> Техническая информация
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h6>Время ответа</h6>
                        <p class="text-muted">{{ analysis.response_time|default:"-" }} сек</p>
                    </div>
                    <div class="col-6 mb-3">
                        <h6>Размер страницы</h6>
                        <p class="text-muted">{{ analysis.page_size|default:"-" }} байт</p>
                    </div>
                    <div class="col-6">
                        <h6>HTTP статус</h6>
                        <p class="text-muted">{{ analysis.status_code|default:"-" }}</p>
                    </div>
                    <div class="col-6">
                        <h6>Заголовков</h6>
                        <p class="text-muted">{{ analysis.total_headings }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статистика -->
        <div class="card stats-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart"></i> Статистика
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h6>H1</h6>
                        <p class="text-muted">{{ analysis.h1_tags|length }}</p>
                    </div>
                    <div class="col-6 mb-3">
                        <h6>H2</h6>
                        <p class="text-muted">{{ analysis.h2_tags|length }}</p>
                    </div>
                    <div class="col-6 mb-3">
                        <h6>H3</h6>
                        <p class="text-muted">{{ analysis.h3_tags|length }}</p>
                    </div>
                    <div class="col-6 mb-3">
                        <h6>H4</h6>
                        <p class="text-muted">{{ analysis.h4_tags|length }}</p>
                    </div>
                    <div class="col-6">
                        <h6>H5</h6>
                        <p class="text-muted">{{ analysis.h5_tags|length }}</p>
                    </div>
                    <div class="col-6">
                        <h6>H6</h6>
                        <p class="text-muted">{{ analysis.h6_tags|length }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Извлеченный текст -->
        {% if analysis.extracted_text %}
            <div class="card stats-card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-file-text"></i> Извлеченный текст
                    </h5>
                    <button class="btn btn-sm btn-outline-light" onclick="copyText()">
                        <i class="bi bi-clipboard"></i> Копировать текст
                    </button>
                </div>
                <div class="card-body">
                    <div id="extracted-text" style="max-height: 300px; overflow-y: auto; background-color: #000; color: #fff; padding: 15px; border-radius: 5px; border: 1px solid #333;">
                        <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; margin: 0; color: #fff;">{{ analysis.extracted_text }}</pre>
                    </div>
                </div>
            </div>
            
            <script>
                function copyText() {
                    const textElement = document.getElementById('extracted-text');
                    const text = textElement.textContent;
                    navigator.clipboard.writeText(text).then(function() {
                        // Показываем уведомление
                        const button = event.target.closest('button');
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="bi bi-check"></i> Скопировано!';
                        button.classList.remove('btn-outline-light');
                        button.classList.add('btn-success');
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('btn-success');
                            button.classList.add('btn-outline-light');
                        }, 2000);
                    });
                }
            </script>
        {% endif %}

        <!-- Информация об анализе -->
        <div class="card stats-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Информация
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    <strong>Сайт:</strong> 
                    <a href="{% url 'tools:website_detail' analysis.website.pk %}" class="text-decoration-none">
                        {{ analysis.website.name|default:analysis.website.url }}
                    </a>
                </p>
                <p class="mb-2">
                    <strong>Тип:</strong> 
                    {% if analysis.website.is_competitor %}
                        <span class="badge bg-warning">Конкурент</span>
                    {% else %}
                        <span class="badge bg-primary">Клиент</span>
                    {% endif %}
                </p>
                <p class="mb-0">
                    <strong>Анализ проведен:</strong> {{ analysis.created_at|date:"d.m.Y H:i" }}
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
